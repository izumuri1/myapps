# .github/workflows/deploy.yml
name: ğŸš€ Auto Deploy to Sakura

# ã„ã¤å®Ÿè¡Œã™ã‚‹ã‹
on:
  push:
    branches: [ main ]    # mainãƒ–ãƒ©ãƒ³ãƒã«ãƒ—ãƒƒã‚·ãƒ¥ã•ã‚ŒãŸæ™‚
  workflow_dispatch:      # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    # 1. ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    # 2. Node.jsç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: './frontend/package-lock.json'
        
    # 3. ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
    - name: ğŸ“¦ Install Dependencies
      working-directory: ./frontend
      run: npm ci
      
    # 4. ãƒ‡ãƒãƒƒã‚°æƒ…å ±ç¢ºèª
    - name: ğŸ” Debug File Structure
      working-directory: ./frontend
      run: |
        echo "ğŸ“ Current directory:"
        pwd
        echo "ğŸ“‚ Frontend contents:"
        ls -la
        echo "ğŸ“‚ src contents:"
        ls -la src/
        echo "ğŸ“‚ config directory:"
        ls -la src/config/ || echo "config directory not found"
        echo "ğŸ“„ config.js content preview:"
        head -5 src/config/config.js || echo "config.js not found"
        
    # 5. Reactã‚¢ãƒ—ãƒªã‚’ãƒ“ãƒ«ãƒ‰
    - name: ğŸ—ï¸ Build React App
      working-directory: ./frontend
      run: npm run build
      
    # 6. ãƒ“ãƒ«ãƒ‰çµæœã‚’ç¢ºèªï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
    - name: ğŸ“Š Check Build Output
      working-directory: ./frontend
      run: |
        echo "ğŸ“ Build completed. Contents:"
        ls -la dist/
        echo "ğŸ“¦ Total size:"
        du -sh dist/
        
    # 7. Reactãƒ•ã‚¡ã‚¤ãƒ«ã‚’www/ã«ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆSFTPï¼‰
    - name: ğŸŒ Deploy React App to www/ (SFTP)
      uses: wlixcc/SFTP-Deploy-Action@v1.2.4
      with:
        server: ${{ secrets.FTP_SERVER }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        local_path: './frontend/dist/*'
        remote_path: '/home/izumuri/www/'
        sftpArgs: '-o ConnectTimeout=5'
        
    # 8. PHPãƒ•ã‚¡ã‚¤ãƒ«ã‚’www/backend/ã«ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆSFTPï¼‰
    - name: ğŸ˜ Deploy PHP Files to www/backend/ (SFTP)
      uses: wlixcc/SFTP-Deploy-Action@v1.2.4
      with:
        server: ${{ secrets.FTP_SERVER }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        local_path: './backend/*'
        remote_path: '/home/izumuri/www/backend/'
        sftpArgs: '-o ConnectTimeout=5'
        
    # 9. å®Œäº†é€šçŸ¥
    - name: âœ… Deployment Success
      run: |
        echo "ğŸ‰ ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå®Œäº†ã—ã¾ã—ãŸï¼"
        echo "ğŸŒ ã‚µã‚¤ãƒˆURL: https://${{ secrets.FTP_SERVER }}/"
        echo "â° ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚åˆ»: $(date)"