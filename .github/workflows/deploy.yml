# .github/workflows/deploy.yml
name: ğŸš€ Auto Deploy to Sakura

# ã„ã¤å®Ÿè¡Œã™ã‚‹ã‹
on:
  push:
    branches: [ main ]    # mainãƒ–ãƒ©ãƒ³ãƒã«ãƒ—ãƒƒã‚·ãƒ¥ã•ã‚ŒãŸæ™‚
  workflow_dispatch:      # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    # 1. ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v3
      
    # 2. Node.jsç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
        
    # 3. ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
    - name: ğŸ“¦ Install Dependencies
      run: npm ci
      
    # 4. Reactã‚¢ãƒ—ãƒªã‚’ãƒ“ãƒ«ãƒ‰
    - name: ğŸ—ï¸ Build React App
      run: npm run build
      
    # 5. ãƒ“ãƒ«ãƒ‰çµæœã‚’ç¢ºèªï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
    - name: ğŸ“Š Check Build Output
      run: |
        echo "ğŸ“ Build completed. Contents:"
        ls -la dist/
        echo "ğŸ“¦ Total size:"
        du -sh dist/
        
    # 6. Reactãƒ•ã‚¡ã‚¤ãƒ«ã‚’www/ã«ãƒ‡ãƒ—ãƒ­ã‚¤
    - name: ğŸŒ Deploy React App to www/
      uses: SamKirkland/FTP-Deploy-Action@4.3.4
      with:
        server: ${{ secrets.FTP_SERVER }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        local-dir: ./dist/
        server-dir: ./www/
        dangerous-clean-slate: true
        
    # 7. PHPãƒ•ã‚¡ã‚¤ãƒ«ã‚’www/backend/ã«ãƒ‡ãƒ—ãƒ­ã‚¤
    - name: ğŸ˜ Deploy PHP Files to www/backend/
      uses: SamKirkland/FTP-Deploy-Action@4.3.4
      with:
        server: ${{ secrets.FTP_SERVER }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        local-dir: ./backend/
        server-dir: ./www/backend/
        
    # 8. å®Œäº†é€šçŸ¥
    - name: âœ… Deployment Success
      run: |
        echo "ğŸ‰ ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå®Œäº†ã—ã¾ã—ãŸï¼"
        echo "ğŸŒ ã‚µã‚¤ãƒˆURL: https://${{ secrets.FTP_SERVER }}/"
        echo "â° ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚åˆ»: $(date)"